<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Professional Knockout Bracket</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
body.fixtures-body {
    background: linear-gradient(135deg, #43cea2, #185a9d);
    min-height: 100vh;
    margin: 0;
    padding-bottom: 80px; /* space for sticky buttons */
}

#bracket-wrapper {
    position: relative;
    margin: 20px auto;
    display: flex;
    justify-content: center;
    padding: 20px 0;
}

.fixture-round {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0 40px;
}

.round-title {
    font-weight: bold;
    margin-bottom: 15px;
    color: #fff;
    text-shadow: 1px 1px 2px #000;
}

.match-card {
    background: #fff;
    padding: 10px 14px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    min-width: 120px;
    text-align: center;
    position: absolute;
    line-height: 1.2; 
    margin-bottom: 5px; 
}
.match-card.bye-match {
    /* Optional: Add specific styling for bye matches if needed */
}

svg#connectors {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
}

/* Buttons sticky at bottom */
.btn-bottom {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
}

/* Connector lines */
svg#connectors path {
    stroke: #ff6a00; /* bright orange */
    stroke-width: 2;
    fill: none;
}

/* Print-specific styling (kept only for clean print of fixtures) */
@media print {
    body * {
        visibility: hidden;
    }
    #bracket-wrapper, #bracket-wrapper * {
        visibility: visible;
    }
    #bracket-wrapper {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(135deg, #e0eafc, #cfdef3);
        padding: 20px;
    }
    .btn-bottom {
        display: none;
    }
}
</style>
</head>
<body class="fixtures-body">

<div class="container-fluid text-center">
    <h1 class="mb-4">üèÜ {{ tournament_name }}</h1>
    <h2 class="mb-4">{{ ttype|capitalize }} Fixtures</h2>

    {% if fixtures_rounds|first is mapping %}
    {% for pool in fixtures_rounds %}
        <h3>{{ pool.name }}</h3>
        <div id="bracket-wrapper-{{ loop.index }}">
            {% set total_rounds = pool.bracket|length %}
            {% set round_matches = pool.bracket %}
            {% for rnd_idx in range(total_rounds) %}
                {% set matches = round_matches[rnd_idx] %}
                <div class="fixture-round" data-round="{{ rnd_idx }}">
                    <div class="round-title">
                        {% if rnd_idx == total_rounds - 1 %}
                            Final
                        {% elif rnd_idx == total_rounds - 2 %}
                            Semi Final
                        {% elif rnd_idx == total_rounds - 3 %}
                            Quarter Final
                        {% elif rnd_idx == total_rounds - 4 %}
                            Pre-Quarter
                        {% else %}
                            Round {{ rnd_idx + 1 }}
                        {% endif %}
                    </div>
                    {% for match_idx in range(matches|length) %}
                        <div class="match-card {% if matches[match_idx][1] is none %}bye-match{% endif %}" data-match="{{ match_idx }}" data-round="{{ rnd_idx }}">
                            {% if matches[match_idx][1] is none %}
                                {{ matches[match_idx][0] }}
                            {% else %}
                                {{ matches[match_idx][0] }} <strong>vs</strong> {{ matches[match_idx][1] }}
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
            <svg id="connectors-{{ loop.index }}">
                <defs>
                    <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="3"
                      orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L0,6 L9,3 z" fill="#ff6a00"/>
                    </marker>
                </defs>
            </svg>
        </div>
        <script>
            // Call JavaScript functions for each pool
            positionMatches('bracket-wrapper-{{ loop.index }}');
            drawConnectors('bracket-wrapper-{{ loop.index }}', 'connectors-{{ loop.index }}');
        </script>
    {% endfor %}
    {% else %}
    <div id="bracket-wrapper">
        {% set total_rounds = fixtures_rounds|length %}
        {% set round_matches = fixtures_rounds %}
        {% for rnd_idx in range(total_rounds) %}
            {% set matches = round_matches[rnd_idx] %}
            <div class="fixture-round" data-round="{{ rnd_idx }}">
                <div class="round-title">
                    {% if rnd_idx == total_rounds - 1 %}
                        Final
                    {% elif rnd_idx == total_rounds - 2 %}
                        Semi Final
                    {% elif rnd_idx == total_rounds - 3 %}
                        Quarter Final
                    {% elif rnd_idx == total_rounds - 4 %}
                        Pre-Quarter
                    {% else %}
                        Round {{ rnd_idx + 1 }}
                    {% endif %}
                </div>
                {% for match_idx in range(matches|length) %}
                    <div class="match-card {% if matches[match_idx][1] is none %}bye-match{% endif %}" data-match="{{ match_idx }}" data-round="{{ rnd_idx }}">
                        {% if matches[match_idx][1] is none %}
                            {{ matches[match_idx][0] }}
                        {% else %}
                            {{ matches[match_idx][0] }} <strong>vs</strong> {{ matches[match_idx][1] }}
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
        <svg id="connectors">
            <defs>
                <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="3"
                  orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L0,6 L9,3 z" fill="#ff6a00"/>
                </marker>
            </defs>
        </svg>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        // --- Position Matches Professionally ---
        function positionMatches() {
            const rounds = document.querySelectorAll('.fixture-round');
            const wrapper = document.getElementById('bracket-wrapper');
            const verticalSpacing = 80;

            if (rounds.length === 0) return;

            const totalFirstRoundSlots = rounds[0].querySelectorAll('.match-card').length;
            let initialGap = (totalFirstRoundSlots * verticalSpacing) / 2;

            rounds.forEach((round, rndIdx) => {
                const matches = round.querySelectorAll('.match-card');
                const gapMultiplier = Math.pow(2, rndIdx);
                const currentRoundGap = gapMultiplier * verticalSpacing;

                matches.forEach((match, idx) => {
                    const topPos = (idx * currentRoundGap) + (currentRoundGap / 2);
                    match.style.top = topPos + 'px';
                });
            });

            const totalHeight = totalFirstRoundSlots * verticalSpacing;
            wrapper.style.height = totalHeight + 'px';
        }

        // --- Draw Connector Lines ---
        function drawConnectors() {
            const svg = document.getElementById('connectors');
            svg.innerHTML = '<defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="3" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,6 L9,3 z" fill="#ff6a00"/></marker></defs>';

            const rounds = document.querySelectorAll('.fixture-round');

            for(let r=0; r<rounds.length-1; r++){
                const current = rounds[r].querySelectorAll('.match-card');
                const next = rounds[r+1].querySelectorAll('.match-card');

                for(let i=0; i<next.length; i++){
                    const nextMatch = next[i];
                    const parent1 = current[i*2];
                    const parent2 = current[i*2+1];
                    
                    const n = nextMatch.getBoundingClientRect();
                    const wrapperOffset = document.getElementById('bracket-wrapper').getBoundingClientRect();
                    const endX = n.left - wrapperOffset.left;
                    const endY = n.top + n.height/2 - wrapperOffset.top;
                    
                    // Draw lines for parent1
                    if (parent1) {
                        const p1 = parent1.getBoundingClientRect();
                        const startX = p1.right - wrapperOffset.left;
                        const startY = p1.top + p1.height/2 - wrapperOffset.top;
                        
                        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
                        path.setAttribute('d', `M${startX} ${startY} C ${(startX+endX)/2} ${startY}, ${(startX+endX)/2} ${endY}, ${endX} ${endY}`);
                        path.setAttribute('stroke','#ff6a00');
                        path.setAttribute('stroke-width','2');
                        path.setAttribute('fill','none');
                        path.setAttribute('marker-end','url(#arrow)');
                        svg.appendChild(path);
                    }

                    // Draw lines for parent2
                    if (parent2) {
                        const p2 = parent2.getBoundingClientRect();
                        const startX = p2.right - wrapperOffset.left;
                        const startY = p2.top + p2.height/2 - wrapperOffset.top;
                        
                        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
                        path.setAttribute('d', `M${startX} ${startY} C ${(startX+endX)/2} ${startY}, ${(startX+endX)/2} ${endY}, ${endX} ${endY}`);
                        path.setAttribute('stroke','#ff6a00');
                        path.setAttribute('stroke-width','2');
                        path.setAttribute('fill','none');
                        path.setAttribute('marker-end','url(#arrow)');
                        svg.appendChild(path);
                    }
                }
            }
        }

        // --- PNG Export ---
        function exportBracketPNG() {
            const node = document.getElementById('bracket-wrapper');
            const originalBg = node.style.background;
            node.style.background = 'linear-gradient(135deg, #e0eafc, #cfdef3)';

            html2canvas(node, {scale:2, backgroundColor: null}).then(canvas => {
                const link = document.createElement('a');
                link.download = 'fixtures.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                node.style.background = originalBg;
            });
        }

        // --- Init ---
        window.addEventListener('load', () => {
            positionMatches();
            drawConnectors();
        });
        window.addEventListener('resize', () => {
            positionMatches();
            drawConnectors();
        });

        document.getElementById('export-png').addEventListener('click', exportBracketPNG);
    </script>
    {% endif %}

    <div class="btn-bottom">
        <a href="{{ url_for('index') }}" class="btn btn-primary me-2">‚¨Ö Back</a>
        <button id="export-png" class="btn btn-info">Export PNG</button>
    </div>
</div>

</body>
</html>

























